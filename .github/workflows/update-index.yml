name:  æ›´æ–°èŠ‚ç‚¹ä»“åº“ä¸»é¡µ

# å·¥ä½œæµæè¿°ï¼šæ­¤å·¥ä½œæµç”¨äºè‡ªåŠ¨ç”Ÿæˆå’Œæ›´æ–°èŠ‚ç‚¹ä»“åº“çš„æ–‡ä»¶ç›®å½•ç´¢å¼•é¡µé¢
# å½“ä»£ç åº“ä¸­çš„æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆ index.htmlã€update-index.html å’Œ files_info.json æ–‡ä»¶
# è¿™äº›æ–‡ä»¶ç”¨äºæ„å»º GitHub Pages ä¸»é¡µï¼Œå±•ç¤ºä»“åº“æ‰€æœ‰æ–‡ä»¶çš„ç›®å½•ç»“æ„

on:
  # 1. æ¨é€äº‹ä»¶è§¦å‘æ¡ä»¶
  push:
    # è·¯å¾„è¿‡æ»¤å™¨ï¼šåªå¯¹æ ¹ç›®å½•ä¸‹çš„æ–‡ä»¶å˜åŒ–è¿›è¡Œå“åº”
    paths:
      # åŒ¹é…æ ¹ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼Œä¸åŒ…æ‹¬å­ç›®å½•ä¸­çš„æ–‡ä»¶
      - '*'              # åŒ¹é…æ ¹ç›®å½•ä¸‹æ‰€æœ‰ééšè—æ–‡ä»¶
      - '.*'             # åŒ¹é…æ ¹ç›®å½•ä¸‹æ‰€æœ‰éšè—æ–‡ä»¶
      # åŒ¹é…styleç›®å½•ä¸‹çš„æ–‡ä»¶
      - 'style/**'
      # åŒ¹é…scriptsç›®å½•ä¸‹çš„æ–‡ä»¶
      - 'scripts/**'
      # æ’é™¤å·²ç”Ÿæˆçš„ç‰¹å®šæ–‡ä»¶
      - '!index.html'
      - '!update-index.html'
      - '!files_info.json'
      # æ’é™¤pythonä¾èµ–æ–‡ä»¶ä»¥åŠmdæ–‡ä»¶
      - '!requirements.txt'
      - '!README.md'
      # æ’é™¤å…¶ä»–å­ç›®å½•ï¼ˆé™¤äº†styleå’Œscriptsï¼‰
      - '!**/'
    # ä»…å¯¹ä¸»åˆ†æ”¯ç”Ÿæ•ˆ
    branches: [ main ]
  
  # 2. å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š7ç‚¹00è‡ªåŠ¨è¿è¡Œï¼ˆUTCæ—¶é—´æ™šä¸Š23:00ï¼‰
  schedule:
    - cron: '00 23 * * *'
  
  # 3. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
  workflow_dispatch:

# æƒé™è®¾ç½®ï¼šå¿…é¡»æˆäºˆå†™å…¥æƒé™æ‰èƒ½æäº¤ç”Ÿæˆçš„æ–‡ä»¶å›ä»“åº“
permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤1ï¼šè·å–ä»£ç åº“å†…å®¹
    - name: ğŸ“¥ æ£€å‡ºä»£ç åº“ï¼ˆå®Œæ•´å†å²ï¼‰
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²ï¼Œç¡®ä¿è„šæœ¬èƒ½è®¿é—®æ‰€æœ‰æ–‡ä»¶ç‰ˆæœ¬
        token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨GitHubä»¤ç‰Œè¿›è¡Œè®¤è¯
        
    # æ­¥éª¤2ï¼šè®¾ç½®Pythonè¿è¡Œç¯å¢ƒ
    - name: ğŸ é…ç½®Python 3.14ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'  # æŒ‡å®šPythonç‰ˆæœ¬ï¼Œç¡®ä¿ä¸è„šæœ¬å…¼å®¹
        
    # æ­¥éª¤3ï¼šå®‰è£…Pythonä¾èµ–åŒ…
    - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
      run: |
        echo "å¼€å§‹å®‰è£…Pythonä¾èµ–..."
        python -m pip install --upgrade pip  # å‡çº§pipåˆ°æœ€æ–°ç‰ˆæœ¬
        
        # æ£€æŸ¥å¹¶å®‰è£…requirements.txtä¸­çš„ä¾èµ–
        if [ -f "requirements.txt" ]; then
          echo "æ‰¾åˆ°requirements.txtï¼Œæ­£åœ¨å®‰è£…ä¾èµ–..."
          pip install -r requirements.txt
        else
          echo "æœªæ‰¾åˆ°requirements.txtï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
        fi
        
        # æ˜¾ç¤ºå·²å®‰è£…çš„åŒ…
        pip list
        
    # æ­¥éª¤4ï¼šè¿è¡ŒPythonè„šæœ¬ç”Ÿæˆindex.htmlæ–‡ä»¶
    - name: ğŸ”§ æ‰§è¡Œindex.htmlç”Ÿæˆè„šæœ¬
      env:
        # ç¯å¢ƒå˜é‡ä¼ é€’
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHubè®¤è¯ä»¤ç‰Œ
        REPO_OWNER: ${{ github.repository_owner }}  # ä»“åº“æ‰€æœ‰è€…
        REPO_NAME: ${{ github.event.repository.name }}  # ä»“åº“åç§°
        BRANCH: main  # ç›®æ ‡åˆ†æ”¯
      run: |
        echo "å¼€å§‹ç”Ÿæˆindex.htmlæ–‡ä»¶..."
        echo "ä»“åº“: $REPO_OWNER/$REPO_NAME"
        echo "åˆ†æ”¯: $BRANCH"
        
        # æ£€æŸ¥ç”Ÿæˆè„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "scripts/generate-index.py" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° scripts/generate-index.py æ–‡ä»¶ï¼"
          exit 1
        fi
        
        # è¿è¡Œç”Ÿæˆè„šæœ¬
        python scripts/generate-index.py
        
        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        echo "ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la index.html update-index.html files_info.json 2>/dev/null || echo "éƒ¨åˆ†æ–‡ä»¶æœªç”Ÿæˆ"
        
    # æ­¥éª¤5ï¼šæäº¤ç”Ÿæˆçš„æ–‡ä»¶å›ä¸»åˆ†æ”¯
    - name: ğŸ“¤ æäº¤å¹¶æ¨é€æ›´æ–°
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        # æäº¤ä¿¡æ¯
        commit_message: |
          ğŸ¤– è‡ªåŠ¨æ›´æ–°index.htmlæ–‡ä»¶
          
          ç”±GitHub Actionså·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ:
          - index.html: ä¸»é¡µèŠ‚ç‚¹ä»“åº“é¡µé¢
          - update-index.html: æ›´æ–°æ—¥å¿—é¡µé¢
          - files_info.json: æ–‡ä»¶å…ƒæ•°æ®
          
          è§¦å‘æ–¹å¼: ${{ github.event_name }}
          è§¦å‘æäº¤: ${{ github.sha }}
          è¿è¡ŒID: ${{ github.run_id }}
        
        # æäº¤çš„æ–‡ä»¶æ¨¡å¼
        file_pattern: |
          index.html
          update-index.html
          files_info.json
        
        # ç›®æ ‡åˆ†æ”¯
        branch: main
        
        # æäº¤é€‰é¡¹
        commit_user_name: 'GitHub Actions Bot'
        commit_user_email: 'actions@github.com'
        commit_author: 'GitHub Actions Bot <actions@github.com>'
        
        # æ£€æŸ¥è®¾ç½®
        skip_dirty_check: false  # æ£€æŸ¥å·¥ä½œåŒºæ˜¯å¦æœ‰æ›´æ”¹
        skip_fetch: false  # æ‰§è¡Œgit fetch
        push_options: '--force'  # å¼ºåˆ¶æ¨é€ï¼ˆå¦‚æœéœ€è¦ï¼‰
        
        # ä»…å½“æ–‡ä»¶å®é™…æ›´æ”¹æ—¶æ‰æäº¤
        create_branch: false
        
    # æ­¥éª¤6ï¼ˆå¯é€‰ï¼‰ï¼šéªŒè¯æäº¤ç»“æœ
    - name: âœ… éªŒè¯æ›´æ–°ç»“æœ
      if: always()  # æ— è®ºä¹‹å‰æ­¥éª¤æ˜¯å¦æˆåŠŸéƒ½æ‰§è¡Œ
      run: |
        echo "=== å·¥ä½œæµæ‰§è¡Œå®Œæˆ ==="
        echo "å·¥ä½œæµåç§°: ${{ github.workflow }}"
        echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"
        echo "è¿è¡ŒID: ${{ github.run_id }}"
        echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        echo "è§¦å‘æäº¤: ${{ github.sha }}"
        echo "æ‰§è¡Œæ—¶é—´: $(date)"
        echo ""
        echo "å·²ç”Ÿæˆçš„æ–‡ä»¶:"
        echo "- index.html: ä¸»é¡µèŠ‚ç‚¹ä»“åº“é¡µé¢"
        echo "- update-index.html: æ›´æ–°æ—¥å¿—é¡µé¢"
        echo "- files_info.json: æ–‡ä»¶ä¿¡æ¯JSONæ•°æ®"
        echo ""
        echo "è¿™äº›æ–‡ä»¶å·²è‡ªåŠ¨æäº¤åˆ° main åˆ†æ”¯"

# å·¥ä½œæµåç»­å¤„ç†
# æ³¨æ„ï¼šæ­¤å·¥ä½œæµè¿è¡Œåï¼Œå¦‚æœä»“åº“å¯ç”¨äº† GitHub Pagesï¼Œ
# æ›´æ–°çš„ index.html å°†è‡ªåŠ¨éƒ¨ç½²ä¸ºç«™ç‚¹é¦–é¡µ