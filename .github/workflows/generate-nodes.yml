name: Generate ä¼˜é€‰åŸŸå YXNodes

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '20 22 * * *'  # UTCæ—¶é—´22:20 = åŒ—äº¬æ—¶é—´06:20
  push:
    paths:
      - '.github/workflows/generate-nodes.yml'
      - 'v_node/config.json'
      - 'v_node/generate_nodes.py'
    branches: [ main, master ]

jobs:
  generate-nodes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Ensure v_node directory exists
      run: |
        mkdir -p v_node
        
    - name: Check if old files exist
      id: check_files
      run: |
        if [ -f "YXNode" ] && [ -s "YXNode" ]; then
          echo "existing_nodes=true" >> $GITHUB_OUTPUT
          echo "å‘ç°ç°æœ‰çš„èŠ‚ç‚¹æ–‡ä»¶"
        else
          echo "existing_nodes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰ç°æœ‰çš„èŠ‚ç‚¹æ–‡ä»¶"
        fi
        
    - name: Run Python script
      id: generate_nodes
      continue-on-error: true  # å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œï¼Œä»¥ä¾¿å¤„ç†å›æ»š
      run: |
        python v_node/generate_nodes.py
        exit_code=$?
        if [ $exit_code -eq 0 ]; then
          echo "result=success" >> $GITHUB_OUTPUT
          echo "èŠ‚ç‚¹ç”ŸæˆæˆåŠŸ"
        else
          echo "result=failed" >> $GITHUB_OUTPUT
          echo "èŠ‚ç‚¹ç”Ÿæˆå¤±è´¥ï¼Œé€€å‡ºç : $exit_code"
        fi
        
    - name: Display generated files
      if: steps.generate_nodes.outputs.result == 'success'
      run: |
        echo "ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la YXNode YXNode.yaml 2>/dev/null || echo "æ–‡ä»¶æœªæ‰¾åˆ°"
        echo ""
        echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
        echo "YXNode å‰5è¡Œ:"
        head -5 YXNode 2>/dev/null || echo "æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
        echo ""
        echo "YXNode.yaml èŠ‚ç‚¹æ•°ç»Ÿè®¡:"
        grep -c "type: vless" YXNode.yaml 2>/dev/null || echo "æ–‡ä»¶ä¸å­˜åœ¨"
        
    - name: å›æ»š - åˆ é™¤æ–°ç”Ÿæˆçš„æ–‡ä»¶
      if: steps.generate_nodes.outputs.result == 'failed' && steps.check_files.outputs.existing_nodes == 'true'
      run: |
        echo "ç”Ÿæˆå¤±è´¥ï¼Œåˆ é™¤å¯èƒ½å·²ç”Ÿæˆçš„ä¸å®Œæ•´æ–‡ä»¶..."
        rm -f YXNode YXNode.yaml 2>/dev/null || true
        echo "ä¿ç•™ç°æœ‰æ–‡ä»¶"
        
    - name: å›æ»š - æ¢å¤å¤‡ä»½æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
      if: steps.generate_nodes.outputs.result == 'failed' && steps.check_files.outputs.existing_nodes == 'true'
      run: |
        # å¦‚æœåŸå§‹æ–‡ä»¶åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­è¢«è¦†ç›–ï¼Œä½†æˆ‘ä»¬æœ‰å¤‡ä»½
        if [ ! -f "YXNode" ]; then
          echo "åŸå§‹æ–‡ä»¶ä¸¢å¤±ï¼Œå°è¯•ä»gitå†å²æ¢å¤..."
          git checkout HEAD -- YXNode 2>/dev/null || true
        fi
        if [ ! -f "YXNode.yaml" ]; then
          git checkout HEAD -- YXNode.yaml 2>/dev/null || true
        fi
        
    - name: æ›´æ–°å¤±è´¥é€šçŸ¥
      if: steps.generate_nodes.outputs.result == 'failed'
      run: |
        echo "âŒ èŠ‚ç‚¹ç”Ÿæˆå¤±è´¥"
        echo "åŸå› : å¯èƒ½APIæœåŠ¡ä¸å¯ç”¨æˆ–æœªè·å–åˆ°æœ‰æ•ˆèŠ‚ç‚¹"
        echo "å¤„ç†: ä¿ç•™ç°æœ‰èŠ‚ç‚¹æ–‡ä»¶ï¼Œä¸è¿›è¡Œæ›´æ–°"
        
    - name: Commit and push if changed
      id: commit_check
      if: steps.generate_nodes.outputs.result == 'success'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        git add YXNode YXNode.yaml
        
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
          if [ ! -s "YXNode" ]; then
            echo "é”™è¯¯: YXNode æ–‡ä»¶ä¸ºç©ºï¼Œæ’¤é”€æ›´æ”¹"
            git reset HEAD YXNode YXNode.yaml 2>/dev/null || true
            git checkout -- YXNode YXNode.yaml 2>/dev/null || true
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ ! -s "YXNode.yaml" ]; then
            echo "é”™è¯¯: YXNode.yaml æ–‡ä»¶ä¸ºç©ºï¼Œæ’¤é”€æ›´æ”¹"
            git reset HEAD YXNode YXNode.yaml 2>/dev/null || true
            git checkout -- YXNode YXNode.yaml 2>/dev/null || true
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æäº¤æ›´æ”¹
          git commit -m "è‡ªåŠ¨æ›´æ–°Cloudflareä¼˜é€‰èŠ‚ç‚¹ [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… èŠ‚ç‚¹æ–‡ä»¶å·²æ›´æ–°å¹¶æ¨é€"
        fi
        
    - name: æ›´æ–°æˆåŠŸæ€»ç»“
      if: steps.generate_nodes.outputs.result == 'success'
      run: |
        echo "âœ… èŠ‚ç‚¹æ›´æ–°æµç¨‹å®Œæˆ"
        if [ "${{ steps.commit_check.outputs.has_changes }}" = "true" ]; then
          echo "ğŸ“¤ å·²æ¨é€æ›´æ–°åˆ°ä»“åº“"
        else
          echo "ğŸ“Š èŠ‚ç‚¹æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æ¨é€"
        fi