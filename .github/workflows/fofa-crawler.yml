name: FOFA Crawler

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      query:
        description: 'FOFAæŸ¥è¯¢è¯­å¥'
        required: true
        default: '"asn!="13335" && server=="cloudflare" && region="HK" && port="443"'
      max_results:
        description: 'æœ€å¤§ç»“æžœæ•°é‡'
        required: false
        default: '10'
      debug:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.12'

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: æ˜¾ç¤ºPythonç‰ˆæœ¬
      run: |
        python --version
        pip --version
    
    - name: å®‰è£…ä¾èµ–
      working-directory: ./f_node
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: åˆ›å»ºé…ç½®æ–‡ä»¶
      working-directory: ./f_node
      run: |
        cat > create_config.py << 'EOF'
import json
import os

# èŽ·å–å‚æ•°ï¼ˆä»ŽçŽ¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼ï¼‰
query = os.environ.get('INPUT_QUERY', 'server=="nginx" && country=="CN"')
cookies = os.environ.get('FOFA_COOKIE', '')
max_results = os.environ.get('INPUT_MAX_RESULTS', '10')
debug_mode = os.environ.get('INPUT_DEBUG', 'false').lower() == 'true'

# åˆ›å»ºé…ç½®å­—å…¸
config = {
    'query_string': query,
    'cookies': cookies,
    'settings': {
        'timeout': 30,
        'max_results': int(max_results),
        'filter_common_ips': True,
        'debug_mode': debug_mode
    }
}

# å†™å…¥æ–‡ä»¶
with open('config.json', 'w', encoding='utf-8') as f:
    json.dump(config, f, indent=2, ensure_ascii=False)

print('âœ… é…ç½®æ–‡ä»¶å·²åˆ›å»º')
print(f'æŸ¥è¯¢è¯­å¥: {query}')
print(f'æœ€å¤§ç»“æžœæ•°: {max_results}')
print(f'è°ƒè¯•æ¨¡å¼: {debug_mode}')

# å®‰å…¨åœ°æ˜¾ç¤ºé…ç½®ï¼ˆéšè—Cookieï¼‰
config_display = config.copy()
config_display['cookies'] = '***éšè—***'
print('\né…ç½®æ–‡ä»¶å†…å®¹:')
print(json.dumps(config_display, indent=2, ensure_ascii=False))
EOF
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        export INPUT_QUERY="${{ inputs.query || 'server=="nginx" && country=="CN"' }}"
        export INPUT_MAX_RESULTS="${{ inputs.max_results || '10' }}"
        export INPUT_DEBUG="${{ inputs.debug || 'false' }}"
        export FOFA_COOKIE="${{ secrets.FOFA_COOKIE }}"
        
        # è¿è¡ŒPythonè„šæœ¬åˆ›å»ºé…ç½®
        python create_config.py
    
    - name: è¿è¡ŒFOFAçˆ¬è™«
      working-directory: ./f_node
      run: |
        if [[ "${{ inputs.debug || 'false' }}" == "true" ]]; then
          python crawler.py --output results.csv --debug
        else
          python crawler.py --output results.csv
        fi
    
    - name: æ£€æŸ¥ç»“æžœæ–‡ä»¶
      working-directory: ./f_node
      run: |
        if [ -f results.csv ]; then
          echo "âœ… ç»“æžœæ–‡ä»¶å·²ç”Ÿæˆ"
          echo "=== æ–‡ä»¶ä¿¡æ¯ ==="
          ls -la results.csv
          line_count=$(($(wc -l < results.csv) - 1))
          echo "è®°å½•æ•°é‡: $line_count æ¡"
          if [ $line_count -gt 0 ]; then
            echo "=== å‰5æ¡è®°å½• ==="
            head -6 results.csv
          else
            echo "æ— æ•°æ®è®°å½•"
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°ç»“æžœæ–‡ä»¶"
          exit 1
        fi
    
    - name: æäº¤ç»“æžœåˆ°ä»“åº“
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add f_node/results.csv
        
        if git diff --cached --quiet; then
          echo "ðŸ“ ç»“æžœæ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          echo "ðŸ“ ç»“æžœæ–‡ä»¶æœ‰æ›´æ–°ï¼Œæäº¤åˆ°ä»“åº“..."
          
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            commit_msg="ðŸ“ˆ è‡ªåŠ¨æ›´æ–°FOFAçˆ¬è™«ç»“æžœ - $(date +'%Y-%m-%d')"
          else
            commit_msg="ðŸ“ˆ æ‰‹åŠ¨è§¦å‘æ›´æ–°FOFAçˆ¬è™«ç»“æžœ - $(date +'%Y-%m-%d %H:%M:%S')"
          fi
          
          git commit -m "$commit_msg"
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… ç»“æžœæ–‡ä»¶å·²æäº¤åˆ°ä»“åº“"
        fi
    
    - name: ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
      run: |
        echo "## FOFAçˆ¬è™«æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f f_node/results.csv ]; then
          count=$(($(wc -l < f_node/results.csv) - 1))
          
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "âœ… **å®šæ—¶ä»»åŠ¡å®Œæˆ - æˆåŠŸçˆ¬å– $count æ¡è®°å½•**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **æ‰‹åŠ¨æ‰§è¡Œå®Œæˆ - æˆåŠŸçˆ¬å– $count æ¡è®°å½•**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $count -gt 0 ]; then
            echo "### å‰5æ¡è®°å½•ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| IPåœ°å€ | ç«¯å£ |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
            
            # æå–å‰5æ¡è®°å½•
            tail -n +2 f_node/results.csv | head -5 | while IFS=, read -r ip port; do
              ip_clean=$(echo "$ip" | tr -d '"' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              port_clean=$(echo "$port" | tr -d '"' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              echo "| $ip_clean | $port_clean |" >> $GITHUB_STEP_SUMMARY
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[æŸ¥çœ‹å®Œæ•´ç»“æžœ](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/f_node/results.csv)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **æ— æ•°æ®è®°å½•**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **æœªç”Ÿæˆç»“æžœæ–‡ä»¶**" >> $GITHUB_STEP_SUMMARY
        fi