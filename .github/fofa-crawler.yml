name: FOFA Crawler

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      query:
        description: 'FOFAæŸ¥è¯¢è¯­å¥'
        required: true
        default: 'server=="nginx" && country=="CN"'
      max_results:
        description: 'æœ€å¤§ç»“æžœæ•°é‡'
        required: false
        default: '100'
      debug:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.9'
  RESULTS_FILE: 'f_node/results.csv'

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–æ‰€æœ‰åŽ†å²ä»¥ä¾¿èƒ½å¤ŸæŽ¨é€
      
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…ä¾èµ–
      working-directory: ./f_node
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: åˆ›å»ºé…ç½®æ–‡ä»¶
      working-directory: ./f_node
      run: |
        cat > config.json << EOF
        {
          "query_string": "${{ github.event.inputs.query || 'server=="nginx" && country=="CN"' }}",
          "cookies": "${{ secrets.FOFA_COOKIE }}",
          "settings": {
            "timeout": 30,
            "max_results": ${{ github.event.inputs.max_results || '100' }},
            "filter_common_ips": true,
            "debug_mode": ${{ github.event.inputs.debug || 'false' }}
          }
        }
        EOF
        echo "é…ç½®æ–‡ä»¶å·²åˆ›å»º"
        # å®‰å…¨åœ°æ˜¾ç¤ºé…ç½®ï¼ˆéšè—Cookieï¼‰
        cat config.json | sed 's/"cookies": ".*"/"cookies": "***éšè—***"/'
        
    - name: è¿è¡ŒFOFAçˆ¬è™«
      working-directory: ./f_node
      run: |
        if [ "${{ github.event.inputs.debug || 'false' }}" = "true" ]; then
          python crawler.py --output results.csv --debug
        else
          python crawler.py --output results.csv
        fi
        
    - name: æ£€æŸ¥ç»“æžœæ–‡ä»¶
      working-directory: ./f_node
      run: |
        if [ -f results.csv ]; then
          echo "âœ… ç»“æžœæ–‡ä»¶å·²ç”Ÿæˆ"
          echo "=== æ–‡ä»¶ä¿¡æ¯ ==="
          ls -la results.csv
          line_count=$(($(wc -l < results.csv) - 1))
          echo "è®°å½•æ•°é‡: $line_count"
          echo "=== å‰10æ¡è®°å½• ==="
          head -11 results.csv
        else
          echo "âŒ æœªæ‰¾åˆ°ç»“æžœæ–‡ä»¶"
          exit 1
        fi
        
    - name: æäº¤ç»“æžœåˆ°ä»“åº“
      run: |
        # é…ç½®gitç”¨æˆ·
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ ç»“æžœæ–‡ä»¶
        git add ${{ env.RESULTS_FILE }}
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --cached --quiet; then
          echo "ðŸ“ ç»“æžœæ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          echo "ðŸ“ ç»“æžœæ–‡ä»¶æœ‰æ›´æ–°ï¼Œæäº¤åˆ°ä»“åº“..."
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            commit_msg="ðŸ“ˆ è‡ªåŠ¨æ›´æ–°FOFAçˆ¬è™«ç»“æžœ - $(date +'%Y-%m-%d')"
          else
            commit_msg="ðŸ“ˆ æ‰‹åŠ¨è§¦å‘æ›´æ–°FOFAçˆ¬è™«ç»“æžœ - $(date +'%Y-%m-%d %H:%M:%S')"
          fi
          
          git commit -m "$commit_msg"
          
          # æŽ¨é€åˆ°ä»“åº“
          git push origin HEAD:${GITHUB_REF#refs/heads/}
          echo "âœ… ç»“æžœæ–‡ä»¶å·²æäº¤åˆ°ä»“åº“"
        fi
        
    - name: ä¸Šä¼ ç»“æžœæ–‡ä»¶ï¼ˆä½œä¸ºArtifactï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: fofa-results-${{ github.run_id }}
        path: ${{ env.RESULTS_FILE }}
        if-no-files-found: warn
        retention-days: 7
        
    - name: ä¸Šä¼ è°ƒè¯•æ–‡ä»¶ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
      if: ${{ github.event.inputs.debug == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: debug-files-${{ github.run_id }}
        path: f_node/debug/
        if-no-files-found: ignore
        retention-days: 3
        
    - name: ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
      run: |
        echo "## FOFAçˆ¬è™«æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f ${{ env.RESULTS_FILE }} ]; then
          count=$(($(wc -l < ${{ env.RESULTS_FILE }}) - 1))
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "âœ… **å®šæ—¶ä»»åŠ¡å®Œæˆ - æˆåŠŸçˆ¬å– $count æ¡è®°å½•**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **æ‰‹åŠ¨æ‰§è¡Œå®Œæˆ - æˆåŠŸçˆ¬å– $count æ¡è®°å½•**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æŸ¥è¯¢è¯­å¥ï¼š" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ github.event.inputs.query || 'server=="nginx" && country=="CN"' }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### å‰5æ¡è®°å½•ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| IPåœ°å€ | ç«¯å£ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          # æå–å‰5æ¡è®°å½•ï¼ˆè·³è¿‡æ ‡é¢˜è¡Œï¼‰
          tail -n +2 ${{ env.RESULTS_FILE }} | head -5 | while IFS=, read -r ip port; do
            # æ¸…ç†å¯èƒ½çš„å¼•å·
            ip=$(echo $ip | sed 's/"//g')
            port=$(echo $port | sed 's/"//g')
            echo "| $ip | $port |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[æŸ¥çœ‹å®Œæ•´ç»“æžœ](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/${{ env.RESULTS_FILE }})" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **æœªç”Ÿæˆç»“æžœæ–‡ä»¶**" >> $GITHUB_STEP_SUMMARY
        fi